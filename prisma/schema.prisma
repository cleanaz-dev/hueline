// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model FormData {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  email       String         @unique
  company     String
  phone       String
  features    String[]
  config      Json?
  hours       String
  name        String
  crm         String
  stage       ClientStage    @default(INTAKE_FORM_COMPLETE)
  subdomainId String?        @unique @db.ObjectId
  subdomain   Subdomain?     @relation(fields: [subdomainId], references: [id])
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  activities  FormActivity[]
}

enum ClientStage {
  INTAKE_FORM_COMPLETE
  SETUP_LINK_SENT
  FEE_PAID
  WORK_COMPLETED
  DEMO_APPROVED
  JOB_COMPLETED
}

model BookingData {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  status    DemoStatus @default(NO_CONTACT)
}

enum DemoStatus {
  NO_CONTACT
  CONTACT
  CLOSED
  LOST
}

model FormActivity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  formId    String   @db.ObjectId
  form      FormData @relation(fields: [formId], references: [id], onDelete: Cascade)
  action    String
  details   String?
  createdAt DateTime @default(now())
}

model Subdomain {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  slug         String  @unique
  companyName  String?
  projectUrl   String?
  logo         String?
  logoWidth    Int?    @default(130)
  logoHeight   Int?    @default(130)
  splashScreen String?
  theme        Json?
  active       Boolean @default(true)

  // 1. Telephony (The numbers displayed in the Settings -> General tab)
  twilioPhoneNumber String? // The number you bought them (e.g. +1555...)
  forwardingNumber  String? // Where calls actually go (e.g. +1416...)

  // 2. Billing (For the Settings -> Billing tab)
  // We store these to generate Portal Links and show status
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // "active", "past_due", "canceled", "trialing"
  planStatus String @default("active")

  // "Professional", "Enterprise", "Starter"
  planName String @default("Professional")

  // To show "Renews on Dec 22"
  currentPeriodEnd DateTime?
  // --------------------------------------------------------

  createdAt DateTime         @default(now())
  updatedAt DateTime?        @updatedAt
  FormData  FormData?
  bookings  SubBookingData[]
  users     SubdomainUser[]
}

model SubdomainUser {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  email        String  @unique
  name         String?
  passwordHash String

  // ✅ NEW: Role management (OWNER, ADMIN, MEMBER)
  role String @default("MEMBER")

  // ✅ NEW: Link to the Subdomain via ID (Not Unique!)
  // This allows multiple users to have the same subdomainId
  subdomainId String    @db.ObjectId
  subdomain   Subdomain @relation(fields: [subdomainId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubBookingData {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  subdomainId String    @db.ObjectId
  subdomain   Subdomain @relation(fields: [subdomainId], references: [id], onDelete: Cascade)
  huelineId   String    @unique

  name           String
  phone          String
  roomType       String
  prompt         String
  originalImages String
  summary        String
  audioUrl       String?
  callDuration   String?
  dimensions     String?
  dateTime       DateTime
  pin            String
  expiresAt      Int

  mockups         Mockup[]
  paintColors     PaintColor[]
  alternateColors AlternateColor[]
  sharedAccess    SharedAccess[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Mockup {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  s3Key        String
  roomType     String
  presignedUrl String?
  colorRal     String
  colorName    String
  colorHex     String

  createdAt DateTime @default(now())
}

model PaintColor {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  ral  String
  name String
  hex  String

  createdAt DateTime @default(now())
}

model AlternateColor {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  ral  String
  name String
  hex  String

  createdAt DateTime @default(now())
}

model SharedAccess {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  email      String?
  accessType String?
  pin        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
