// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model FormData {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  email       String         @unique
  company     String
  phone       String
  features    String[]
  config      Json?
  hours       String
  name        String
  crm         String
  stage       ClientStage    @default(INTAKE_FORM_COMPLETE)
  subdomainId String?        @unique @db.ObjectId
  subdomain   Subdomain?     @relation(fields: [subdomainId], references: [id])
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  activities  FormActivity[]
}

enum ClientStage {
  INTAKE_FORM_COMPLETE
  SETUP_LINK_SENT
  FEE_PAID
  WORK_COMPLETED
  DEMO_APPROVED
  JOB_COMPLETED
}

model BookingData {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  status    DemoStatus @default(NO_CONTACT)
}

enum DemoStatus {
  NO_CONTACT
  CONTACT
  CLOSED
  LOST
}

model FormActivity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  formId    String   @db.ObjectId
  form      FormData @relation(fields: [formId], references: [id], onDelete: Cascade)
  action    String
  details   String?
  createdAt DateTime @default(now())
}

model Subdomain {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  slug         String  @unique
  companyName  String?
  projectUrl   String?
  logo         String?
  logoWidth    Int?    @default(130)
  logoHeight   Int?    @default(130)
  splashScreen String?
  theme        Json?
  active       Boolean @default(true)

  twilioPhoneNumber String?
  forwardingNumber  String?

  stripeCustomerId     String?
  stripeSubscriptionId String?
  planStatus           String    @default("active")
  planName             String    @default("Professional")
  currentPeriodEnd     DateTime?
  planPrice  String?

  createdAt DateTime         @default(now())
  updatedAt DateTime?        @updatedAt
  FormData  FormData?
  bookings  SubBookingData[]
  users     SubdomainUser[]
  logs      Logs[]
}

model SubdomainUser {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  email        String  @unique
  name         String?
  passwordHash String
  imageUrl     String?
  role         String  @default("MEMBER")

  subdomainId String    @db.ObjectId
  subdomain   Subdomain @relation(fields: [subdomainId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubBookingData {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  subdomainId String    @db.ObjectId
  subdomain   Subdomain @relation(fields: [subdomainId], references: [id], onDelete: Cascade)
  huelineId   String    @unique

  name                String
  phone               String
  roomType            String
  prompt              String
  originalImages      String
  summary             String
  dimensions          String?
  dateTime            DateTime
  pin                 String
  expiresAt           Int
  initialIntent       CallReason  @default(NEW_PROJECT)
  currentCallReason   CallReason?
  currentProjectScope String?
  projectType         String?
  lastCallAt          DateTime?
  lastCallAudioUrl    String?

  mockups         Mockup[]
  paintColors     PaintColor[]
  alternateColors AlternateColor[]
  sharedAccess    SharedAccess[]
  exports         Export[]
  calls           Call[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs      Logs[]
}

model Call {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  callSid      String  @unique
  recordingSid String?
  audioUrl     String?
  duration     String?
  status       String?

  intelligence CallIntelligence?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingDataId])
}

model CallIntelligence {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  callId String @unique @db.ObjectId
  call   Call   @relation(fields: [callId], references: [id], onDelete: Cascade)

  callReason               CallReason @default(NEW_PROJECT)
  hiddenNeedsFound         Boolean    @default(false)
  surfacePrepNeeds         Boolean    @default(false)
  structuralNeeds          Boolean    @default(false)
  technicalNeeds           Boolean    @default(false)
  estimatedAdditionalValue Float      @default(0)
  projectScope             String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([callReason])
  @@index([hiddenNeedsFound])
}

model Export {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  jobId       String         @unique
  bookingId   String         @db.ObjectId
  booking     SubBookingData @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resolution  String
  imageCount  Int
  status      String
  downloadUrl String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  completedAt DateTime?

  @@index([bookingId])
}

model Mockup {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  s3Key        String
  roomType     String
  presignedUrl String?
  colorRal     String
  colorName    String
  colorHex     String

  createdAt DateTime @default(now())

  @@index([bookingDataId])
}

model PaintColor {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  ral  String
  name String
  hex  String

  createdAt DateTime @default(now())

  @@index([bookingDataId])
}

model AlternateColor {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  ral  String
  name String
  hex  String

  createdAt DateTime @default(now())

  @@index([bookingDataId])
}

model SharedAccess {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)

  email      String?
  accessType String?
  pin        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([bookingDataId])
}

enum CallReason {
  NEW_PROJECT
  STATUS_UPDATE
  COLOR_CHANGE
  PRICING
  FOLLOW_UP
  OTHER
}

model Logs {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relations
  bookingDataId String         @db.ObjectId
  bookingData   SubBookingData @relation(fields: [bookingDataId], references: [id], onDelete: Cascade)
  
  // Keep SubdomainID for fast filtering at the account level
  subdomainId   String         @db.ObjectId
  subdomain     Subdomain      @relation(fields: [subdomainId], references: [id], onDelete: Cascade)

  // Core Data
  type          LogType
  actor         LogActor       @default(SYSTEM) // <--- NEW: Who did it?
  
  title         String         // e.g. "New Call", "Status Update"
  description   String?        // e.g. "Client asked about pricing"
  
  // THE SECRET WEAPON: Store specific data here without new columns
  // Call: { "duration": 120, "sentiment": "positive" }
  // Payment: { "amount": 1500, "stripeId": "..." }
  // Status: { "old": "NEW_PROJECT", "new": "PRICING" }
  metadata      Json?          

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([bookingDataId])
  @@index([subdomainId])
}

enum LogType {
  CALL
  MOCKUP
  PAYMENT
  STATUS_CHANGE  // Vital for tracking the pipeline
  SMS            // If you send texts
  NOTE           // If the painter wants to write a manual note
}

enum LogActor {
  AI             // The Voice Agent / Gemini
  SYSTEM         // Automated tasks (e.g. scheduled reminders)
  PAINTER        // The Admin User
  CLIENT         // The Homeowner
}